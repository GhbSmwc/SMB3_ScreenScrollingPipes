<html>
	<head>
		<style>
			html {
			background-color: #101010;
			color: rgb(221, 221, 221);
			font-family: sans-serif;
			}
			
			table, th, td {
			border: 1px solid white;
			border-collapse: collapse;
			}
			
			abbr{cursor: help;}
			img.img-hor {
				-moz-transform: scaleX(-1);
				-o-transform: scaleX(-1);
				-webkit-transform: scaleX(-1);
				transform: scaleX(-1);
				filter: FlipH;
				-ms-filter: "FlipH";
			}
			div.CodeBlock {
				overflow: auto;
				width: 1000px;
				height: 500px;
				border: 1px solid white;
				resize: both;
				background-color: #101010;
			}
			pre {
				margin: 0px;
			}
			*.FixedWidth {
				font-family: monospace;
			}
			
			*.NoLineBreak {
				font-family: monospace;
				white-space: pre;
			}
			*.Center {
				text-align: center;
			}
			li {
				padding: 5px;
			}
			tr.RedBackground {
				background-color: #400000;
			}
		</style>
	</head>
<body style="max-width: 1000px; margin: auto; padding: 15px">

<center><h1>Screen Scrolling Pipes</h1></center>
<center><h2>By GreenHammerBro.</h2></center>
<hr>
This block pack contains custom block pipes that when the player enters them, instead of
screen-fading to the next level, the player will move through the pipes (along with the screen following the player) to the other end.<br><br>

<hr>
<h3>Table of Contents</h3>
<ol>
	<li>
		<a href="#Introduction" id="TOC_Introduction">Introduction</a>
		<ol>
			<li><a href="#FeaturesNotSeenBefore" id="TOC_FeaturesNotSeenBefore">Features not seen before</a></li>
		</ol>
	</li>
	<li>
		<a href="#Insertion" id="TOC_Insertion">How to insert</a>
	</li>
	<li>
		<a href="#ExtraFeatures" id="TOC_ExtraFeatures">Extra features</a>
		<ol>
			<li><a href="#ScreenScrollingWarpPipes" id="TOC_ScreenScrollingWarpPipes">Screen Scrolling *warp* pipes (warp/drag mode)</a></li>
			<li><a href="#CapCannons" id="TOC_CapCannons">Pipe cap cannons</a></li>
		</ol>
	</li>
	<li>
		<a href="#FAQ" id="TOC_FAQ">F.A.Q</a>
	</li>
	<li>
		<a href="#Notes" id="TOC_Notes">Notes</a>
	</li>
	<li>
		<a href="#TOC_Credits" id="TOC_CreditsBack">Credits</a>
	</li>
</ol>
<hr>


<h2><a href="#TOC_Introduction" id="Introduction">^</a>Introduction</h2>
The primary purpose of this release was because FuSoYa's SMB3 screen scrolling pipes are incompatible with the custom block
insertion tool; <i>Gopher Popcorn Stew</i> (GPS). Although <a href="https://www.smwcentral.net/?p=section&a=details&id=19984">it was updated to work with GPS</a> on 05/30/2019, glitches remain due to being a mere port to the new block inserter tool:

<ul>
<li>The player will be teleported to the last pipe exited if the player hits the bottom of any horizontal
pipe caps (including small ones), translucent block, or on/off block (on the latest version). If
the player haven't enter the pipes at all, will be teleported to the top-left corner of the level.</li><br>

<li>If the player's pipe movement travel ends with going left, then vertical (going up or down), and then exit,
the player's X position will be slightly to the left from the center of the pipe.</li><br>

<li>If the player is carrying a sprite, and drops the sprite as he exits an upwards facing pipe cap, the sprite
will be clipped into the cap part of the pipe:<br>
<img src="Readme_files/FuSoYaPipe_SpriteClipTopCapBug.gif">
</li><br>

<li>Prior to the release of this package, old screen scrolling pipes (FuSoYa isn't the only one, MikeyK made his)
require an exit tile (air or water) in front of their caps, thus making the placements of blocks around it more
inconvenient (requires an extra space of tiles)). FuSoYa, is even worse, given that each direction uses their own exit tile rather than shared, you couldn't place the pipes like this without glitches:<br>
<img src="Readme_files/FuSoYaBulkyExitTiles.png"><br>
You wouldn't want these in your hack:<br>
<img src="Readme_files/FuSoYaTopCapGlitch.gif"><img src="Readme_files/FuSoYaTopCapGlitch1.gif"></li><br>

<li>If you try to enter the top of a small vertical pipe cap and slip off the right edge, Mario can &ldquo;escape&rdquo;
the exit tile placed on top of it, causing mario to be in his pipe state without entering the pipe:<br>
<img src="Readme_files/FuSoYaPipe_TopVertMiniPipeCapBug.gif"><br>
This is due to the exit tile's hitbox not reaching rightwards far enough.</li><br>

<li>The range that is allowed to enter a small vertical pipe cap is not what you expect. Mario's relative X position
(<kbd>MarioRelativeXPos = MarioXPos - PipeCapXPos</kbd>) must be values ranging from <kbd>-1</kbd> to <kbd>+6</kbd>
(both numbers inclusive) to be able to enter, therefore, it would look like this:<br>
<img src="Readme_files/FuSoYaPipe_SmallVerticalPipeXPosAllowed.png"><br>
Here is how inconsistent to enter them:<br>
<img src="Readme_files/FuSoYaPipe_SmallVerticalPipeXPosTolorance.gif"></li><br>

<li>Mario will interact with any blocks placed directly below the horizontal pipes (so a muncher can kill the player
inside the pipe). Note that in this package, for small horizontal pipes, the player will interact with blocks placed
above the pipe, <a href="#SmallMarioCannotInteractAboveAndBelowHorizPipes">see here</a> to fix that.</li><br>

<li>Leftwards facing pipe caps (including small pipes) have the block being passable (&ldquo;suck&rdquo; mario in) and setting
the player's entering pipe state are being separate and don't always do both together for 1 frame, leading to minor oddities like this:<br>
<img src="Readme_files/FuSoYaPipe_HorizPipeEjectedFromEnteringRightwards.gif"><br>
By tapping right for 1 frame, it tries to suck Mario in, but doesn't set Mario's pipe state until further embedded into the pipe cap, therefore
Mario gets ejected out as if he is clipping into a solid block.</li><br>

<li>When exiting a small pipe at the top, Mario gets pushed to the left by 1 unit (pixel), this is due to mario switching back to &ldquo;out-of-pipe&rdquo;
state before he fully emerges from the pipe, so he slightly clips into the block.</li>
</ul>



<h3><a href="#TOC_FeaturesNotSeenBefore" id="FeaturesNotSeenBefore">^</a>Features not seen before:</h3>
<ul>
<li>This package do not use exit tiles placed in front of pipe caps (air tiles or water tiles placed in front of pipe caps),
instead it relies on a RAM frame timer to determine if the player is fully out of the pipes; Therefore you can put any tiles
(obviously you shouldn't put solid tiles there) without worry.</li><br>

<li>Turn pipe corners for small pipes. FuSoYa did feature small pipes that can only be entered by
small Mario, but have forgotten the turn pipe corners, thus straight pipes with gaps for turns
are needed on FuSoYa's SSPs.</li><br>

<li>As of version 3.2.2, turn pipe corners now have a smoother change of direction instead of
snapping the player's coordinates when approaching them. It wait tills Mario's position is at or
past the point he needs to change direction (it will center the player correctly).</li><br>

<li>Customizable speed. Because why not? (be careful not to set to speeds that are too fast though).</li><br>

<li>As of version 4.0.0, a brand new feature was added: Screen Scrolling *warp* pipes. Inspired by
WhiteYoshiEgg's <i><a href="https://www.smwcentral.net/?p=section&a=details&id=20835">Carryable Pipe</a></i>,
this gimmick lets you have non-physically-connected pipes in your level without any required blocks in between,
meaning you don't have to worry about the path being in the way of designing levels in between those two points.</li>

</ul>

<h2><a href="#TOC_Insertion" id="Insertion">^</a>Insertion</h2>
<h3>What you need:</h3>
<ul>
<li><a href="https://www.smwcentral.net/?p=section&a=details&id=39036">Uberasm Tool</a> (v2.0+ required)</li>
<li><a href="https://www.smwcentral.net/?p=section&a=details&id=19047">Gopher Popcorn Stew (GPS)</a></li>
<li>Lunar Magic's map16 page 4 (and/or 5, if you're only going to use the &ldquo;main parts&rdquo;) not used, unless you can <a href="#MoveToDifferentM16Page">move it to another page</a></li>
<li><a href="https://www.smwcentral.net/?p=section&a=details&id=41329">Lunar Magic v3.0+</a>. The provided levels need to have a version of LM that supports custom level dimensions.</li>
<li><a href="https://www.smwcentral.net/?p=section&a=details&id=18741">No More Sprite Tile Limits patch</a>. Certain sprites on screen randomly disappear when in pipes. Ignore this if you have SA-1 installed.</li>
<li>
	<a href="https://www.smwcentral.net/?p=section&a=list&s=smwpatches&u=0&g=1&f%5Bname%5D=scroll">Screen scrolling patches</a> that allows faster vertical scrolling with the player if you are planning to have any form of
	fast vertical speed. If the player moves down more than 4 pixels per frame long enough, the player may catch the death barrier and triggers a death sequence. Going upwards, the screen caps the player to 3 pixels per
	frame once the player reaches the top barrier (at <kbd>PlayerYPosScrn = #$FF80</kbd>, or -128 (set at <kbd>$00F597</kbd>)). Patches including but not limited to:
	<ul>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=19676">Blind Devil's Reprogrammed Vertical Scroll</a></li>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=26861">My center scroll patch</a>, with <kbd>!Setting_CenterScroll_ScrollType</kbd> set to 1 and using &ldquo;Vertical Scroll at Will&rdquo; setting.</li>
	</ul>
</li>
</ul>
<h2>Recommended</h2>
<ul>
	<li>
		<a href="https://www.smwcentral.net/?p=section&a=details&id=33679">Player X speed patch</a>. If you're using the horizontal cannon pipes, the player can inadvertenly slow down when
		holding in the direction he's fired.
	</li>
	<li>
		<a href="https://www.smwcentral.net/?p=section&a=details&id=30127">Yoshi Pipe Animation Fix</a>, by Kevin. Fixes a visual bug where if RAM <a href="https://smwc.me/m/smw/ram/7E1419"><kbd>$7E1419</kbd></a> is set
		to any nonzero value, yoshi will act as if he's entering a pipe reguardless if the player is on yoshi or not.
	</li>
	<li>
		<a href="https://www.smwcentral.net/?p=section&a=details&id=16550">P-balloon fix</a>. One of the major bugs is that the player's facing direction is locked during a p-balloon (last set prior to grabbing the balloon), and
		that the horizontal pipes (both vanilla exit-enabled and my screen-scrolling) only allow entry when facing towards them.
	</li>
</ul>
<h2>Tools provided</h2>
<ul>
	<li><a href="Readme_files/JS_GPSBlockListRelocator.html" id="Return_JSToolList">GPS block list relocator tool</a> I made this tool to deal with moving large number of blocks. By default, almost the entire page of 4 and 5 are used, and you
	can either move your custom blocks or my pipes to a different page (if latter and you still want to test the provided level, you'll need to use LM's &ldquo;Remap Direct Map16&rdquo;, see <kbd>Menubar &rarr; Edit &rarr; Remap Direct Map16</kbd>).</li>
</ul>


<h3>Instructions to apply to your game.</h3>

<ol>
<li>Lunar Magic (Everything related to this is located in <kbd>LM_Stuff</kbd> folder.)</li><br>
<ol>
<li>Simply copy the graphic files and paste them in their respective folder. The file naming should
be obvious.</li><br>

<li>Open the level file <kbd>demonstration.mwl</kbd> (level $0105). (MenuBar &gt; File &gt; Open Level from
file...). Note that <kbd>demonstration_WrapTest.mwl</kbd> (level $0106) is for testing a level wrap mechanic for <kbd>UberasmTool_Stuff/level/SSP_WarpDragLevelWrap.asm</kbd>.</li><br>

<li>Open your map16 editor, and import <kbd>tilemap.map16</kbd> (Question block with a red left
arrow on it; <img src="Readme_files/LM_ImportMap16FromFile.png">). After the blocks are imported, hit save.<sup>[<a href="#BlockListRelocatorInfo">Map 16 location note</a>]</sup></li>

</ol>

<li>ASM</li>
<ol>
<li>Define note</li>
<ol>
<li>Make necessary changes to <kbd>SSPDef/Defines.asm</kbd> (including making sure the freeram it uses not conflict with other unrelated ASM resources). And make sure you read the comments. Of course, if you already inserted the ASM
codes and wish to edit and re-insert, make sure you have the copies of it up to date with correct information and reinsert to update. You must update every time you make changes.</li>

</ol>
<li>Uberasm Tool (inside <kbd>UberasmTool_Stuff</kbd> folder)</li>
<ol>
<li>Copy the folder (the folder itself) <kbd>SSPDef</kbd> and paste it in the same directory as uberasm tool.exe
is in, not in any of the subfolder of uberasm tool.</li><br>

<li>Stuff within <kbd>UberasmTool_Stuff</kbd> should be obvious with convenient file names. Thanks to UAT2.0, you can have multiple ASM files for the same level/gamemode/oveworld (separated via commas).</li><br>

<li>
	On Uberasm tool's <kbd>list.txt</kbd>, under gamemode, just put this:
	<div class="CodeBlock" style="width: 295px; height: 18px;"><pre>14	GM14_ScreenScrollingPipes.asm</pre></div>
	And to test a level wrap mechanic, add this (under &ldquo;<kbd>level:</kbd>&rdquo;):
	<div class="CodeBlock" style="width: 327px; height: 16px;"><pre>106	SSP_WarpDragLevelWrap.asm : %00000011</pre></div>
	Where the extra byte format is, in binary, <kbd>%000000VH</kbd>, that <kbd>H</kbd> and <kbd>V</kbd> is a bit flag to apply an <i>invert</i>, when set (<kbd>1</kbd>) along the longitudinal edge (for <kbd>H</kbd>, it's the left and
	right edge of the level that would invert the Y position, and for <kbd>V</kbd>, it's the top and bottom that would invert the X position). The provided test level <kbd>demonstration_WrapTest.mwl</kbd> will work regardless of the
	invert wrap settings.
</li><br>


<ul><li>Title screen note</li>
<ol>
<li>If you are planning to have this also apply on the title screen, create another entry for <kbd>list.txt</kbd> under <kbd>gamemode</kbd>:
<div class="CodeBlock" style="width: 285px; height: 20px;"><pre>7	GM14_ScreenScrollingPipes.asm</pre></div></li>
<li>Please note that <kbd>Fixes.asm</kbd> <b>modifies some of the player's vanilla physics for the entire game</b> to check the freeram used by the screen scrolling pipes. Therefore the RAMs are reserved even when
<kbd>GM14_ScreenScrollingPipes.asm</kbd>'s code is not running.</li>
</ol>
</ul>
<li>Now insert the code by running uberasm tool.</li>
</ol>

<li>GPS (in <kbd>GPS_Stuff</kbd> folder)</li>
<ol>
<li>Copy the <i>folder</i> of <kbd>SSP_Tiles</kbd>, and paste that in GPS's <kbd>blocks</kbd> folder. After doing that, then
paste another copy of <kbd>SSPDef</kbd> in the main directory of GPS (where the exe program is at, not in the subfolder/subdirectory).
Also paste the asm file(s) in <kbd>BlockRoutines</kbd> in GPS's routines folder.</li><br>

<li>Copy the text from one of the two files in <kbd>blocks_list</kbd> folder and paste it in GPS's list file. Now run GPS to insert the blocks.*
Both the tile lists and the map16 blocks provided must match.</li><br>
</ol>

<li>Patches (in <kbd>Patches</kbd> folder)</li>
<ol>
<li>Before you install <kbd>Fixes.asm</kbd>, I want to warn you that patch also includes a hijack at <kbd>$00EA18</kbd> (this is normally the code that pushes the player leftwards
if he is embedded inside a block, such as Big Mario inside a 1-tile tall space, his head clips inside the ceiling block) to prevent this small bug: If small mario tries to enter
the downwards-facing small pipe cap by hitting the bottom corners, he'll enter 1 pixel to the left than where he supposed to be positioned:<br>
<img src="Readme_files/PushedLeftFromCenterSmallPipeDownwardsCap.gif"><br>
Unfortunately, the “<a href="https://www.smwcentral.net/?p=section&a=details&id=19932">WJNB fix patch</a>” also hijacks that spot (a range from <kbd>$00EA16</kbd> to <kbd>$00EA21</kbd>). It is okay to patch Fixes.asm AFTER patching
the WJNB because Fixes.asm will auto-detect that and will not modify WJNB's hijack in any way. But if you installed Fixes.asm first, and wanted to install the WJNB fix patch afterwards, open Defines.asm, and set <kbd>!Setting_SSP_Hijack_00EA18</kbd>
to 0, reinstall Fixes.asm, <b>and then</b> install the WJNB fix patch. And whatever you do, DON'T install the WJNB patch with Fixes.asm being installed with <kbd>!Setting_SSP_Hijack_00EA18</kbd> set to 1, or a potential freespace may have been leaked.</li>

<li>Not much to say, simply install <kbd>Fixes.asm</kbd> via asar. This patch fixes various bugs relating with the pipes and sprites to not interact with the player during a pipe travel. Make sure you do not move the file, else you have to edit the
<kbd>incsrc "&ltpath to the defines file&gt;"</kbd> to get it to work.</li><br>
</ol><br>
<li>Pixi (in <kbd>Pixi</kbd> folder). This mainly deals with making custom sprites be compatible with the SSPs. Mainly the fact that custom sprites may interact with the player in ways they shouldn't, and they should be rendered invisible
with the player (by skipping the graphics code/routine) when dragged into the pipe.</li><br>
<ol>
<li>The first thing you want to do is similar to Uberasm tool and GPS-- Paste a copy of <kbd>SSPDef</kbd> in the same directory as <kbd>pixi.exe</kbd> is located.</li><br>
<li>Paste all ASM files in this package's <kbd>Pixi/routines</kbd> in pixi's <kbd>routines</kbd> folder.</li><br>
</ol>
</ol>

<li>Level usage</li>

<ol>
Click <a name="UseBlocksInLevel" href="Readme_files/BlocksUsageInLevel.html">here</a> for how to use in levels. Note that some info are out of date due to the rearragement of blocks since the 4.0.0 update. I kept this info,
along with the old map16 blocks (list and a <kbd>.map16</kbd> file), for in case you wanted to port your blocks to a newer version without tedious remapping.<br><br>

See <a name="UseBlocksInLevel2" href="Readme_files/BlocksUsageInLevel2.html">here</a> for up-to-date information.
</ol>

</ol>

<span id="MoveToDifferentM16Page">*If you need to move the pipes or your other blocks to a different map16 page, use <a href="Readme_files/JS_GPSBlockListRelocator.html" id="BlockListRelocatorInfo">this tool</a> to move to a different page number.</span>

<h2><a href="#TOC_ExtraFeatures" id="ExtraFeatures">^</a>Extra features</h2>
<h3><a href="#TOC_ScreenScrollingWarpPipes" id="ScreenScrollingWarpPipes">^</a>Screen Scrolling *warp* pipes (warp/drag mode)</h3>
<p>I also have given a new feature that let you have pipes &ldquo;warp&rdquo; (or teleport) the player to another location in the same level (this is not as in, refresh the level! I mean to be at another location without using exit-enabled
pixelulate to black level-refresh effects). This is somewhat similar to the <a href="https://www.smwcentral.net/?p=section&a=details&id=20835">carryable pipe</a> in the sprites section that the pipe pairs appear not to be
physically connected to another, but they acts as portals that &ldquo;teleports&rdquo; (The player actually gets dragged to his destination ignoring all object and sprite interactions, since instant teleporting result in graphical glitches)
the player to the other end.</p>

<p>This works by making use of the aiming routine so that the player will seamlessly move to where he should be dragged to without the noticeable 8-direction movement as the screen scrolls to follow the player. During this effect,
he will ignore all object interactions and the way to determine mario should switch back to states $01-$08 (his pipe state in <kbd>!Freeram_SSP_PipeDir</kbd>) is using uberasm to generate a destination point hitbox
which will revert the state and reenable block interaction when collided.</p>

<p>This will allow you to have anything in between those two ends of the travel without interfering the player's pipe traveling (<a href="#MarioInPipeInteractWithCustomSprites">but be careful with some custom sprites though</a>), enabling you
not to be required to have any pipe-related blocks in the area in between.</p>

<p>Psst, Nintendo called them &ldquo;warp pipes&rdquo; instead of just &ldquo;pipes&rdquo; because of that very reason of not always being physically connected to the other end.</p>

<p>To get this running (when using the warp-drag mode block), see this tutorial <a href="Readme_files/BlocksUsageInLevel2.html#TOC_WarpMode" target="_blank">here</a></p>

<p>I also included a per-level ASM code for uberasm tool, <kbd>SSP_WarpDragLevelWrap.asm</kbd>, that adds a trigger when Mario hits the edge of the level (screen if disabled scrolling) while pipe-traveling, to send him to the opposite edge of the level with optionally inverting where on the edge
the player should emerge from.</p>

<h3><a href="#TOC_CapCannons" id="CapCannons">^</a>Cap cannons</h3>
<p>Along with the variations of cap cannons added (including the ability to have each cap individually allow or forbid things like carrying and riding yoshi), I also featured pipe caps
that when exit out of, flings the player a short distance with momentium. This is especially useful for kaizo hacks involving platform tricks. Note that I recommend installing the <a href="https://www.smwcentral.net/?p=section&a=details&id=24862">Player X speed</a>
fix patch because of a quirk with SMW's horizontal speed handling that if you are going faster than max, and you hold left or right in the direction he's going, Mario will decelerate rather than to keep his speed.</p>

<p>See the list of blocks in the <a href="Readme_files/BlocksUsageInLevel2.html" target="_blank">block placement section</a></p>
<h2><a href="#TOC_FAQ" id="FAQ">^</a>FAQ</h2>
<ul>

<li>How do I set the freeram and settings?
<ul><li>Look in <kbd>SSPDef/Defines.asm</kbd>. If you make changes to it, you MUST update the other copies of it in GPS and uberasm
tool so they use updated information.</li></ul></li><br>

<li>When Mario enters a pipe, Mario passes through them as if they turned into air tiles!
<ul><li>You've forgot to insert the uberasm tool code <kbd>GM14_ScreenScrollingPipes.asm</kbd> as gamemode 14, which is needed as blocks have certain limitations.</li></ul><br>
</li>

<li>Horizontal pipe caps can't entered even if I used ones that are labeled &ldquo;enterable&rdquo;!
<ul><li>You forget to install a patch included in this package, go into the folders: <kbd>/Patches/Fixes.asm</kbd>. This fixes a ton of bugs and
other issues needed so that the pipes are ensure no major issues will happen.</li></ul><br>
</li>

<li>I've found a bug! Will you fix it?
<ul><li>Yes, but only if I'm active on smw central. However, in the case that I'm inactive, you are free to re-upload my works, just make sure you
give credit.</li></ul></li><br>

<li>How do I modify the speeds, and other customizations?
<ul><li>Open <kbd>SSPDef/Defines.asm</kbd>, there should be things like what RAM you want to use, if you wanted the pipes to not freeze time, etc.
Just make sure you read the descriptions, espically when you are changing the pipe cap speeds (how mario exit the pipes rely on a timer of when
the player will be out of &ldquo;pipe mode&rdquo;). Make sure you read <a href="#SpeedClipping">this</a> because fast speeds can cause the player to phase through turn
corners and exit caps without interacting them, causing the player to continue in his pipe state and direction when he shouldn't.</li></ul></li>
</ul>

<h2><a href="#TOC_Notes" id="Notes">^</a>Notes</h2>
<ul>
	<li>
		If you carry any <b>custom</b> sprites through these pipes, they will not go behind the layer;
		appearing superimpose of the pipe as mario is being behind the layer. Unless you can
		make it change the yxppccct using this code to be used in a custom sprite's code:
<div class="CodeBlock" style="width: 857px; height: 318px;"><pre>
SSPPriority:
	%SSPDetectSpriteCarriedInPipe() ;&gt;Carry clear = Not carried inside the pipe, Set: Carried into the pipe.
	BCC .InFront
	.Behind
		LDA !15F6,x
		AND.b #%11001111
		BRA .Skip
	.Infront
		LDA !15F6,x
		ORA.b #%00xx0001 ;&gt;Replace the Xs with a binary number that is the sprite's original priority:
			;00 = Appear behind everything except Layer 3 tiles with priority setting 0
			;01 = Appear behind everything except Layer 3 tiles (unless they have priority setting
			;     1 and the "force above everything" bit is set)
			;10 = Appear in front of Layer 3 tiles (unless they have priority setting 1 and the
			;     "force above everything" bit is set) and Layer 1 and 2 tiles with priority setting 0;
			;     appear behind Layer 1 and 2 tiles with priority setting 0 (this is SMW's normal setting
			;     for most sprites)
			;11 = Appear in front of everything, except Layer 3 tiles with priority setting 1 if the
			;     "force above everything" bit is set
	.Skip
		STA !15F6,x</pre></div><br>
		Same also applies if the carried sprite is a stunned sprite that can unstun themselves during a pipe travel, with <kbd class="NoLineBreak">!Setting_SSP_FreezeTime == 0</kbd>, then you would set the timer to some value every frame
		(such as the value of <kbd>!Setting_SSP_Minimal_StuntimerSprites</kbd>) to prevent it.
		<ul>
			<li>
				Also, this SSP package is intended to make both the player and the carried sprite invisible when he fully enters
				the pipe (when his entering animation timer hits 0) so that you can have non-physically-connected pipes without the
				carried sprite revealing the player's position. However, this only works with SMW's sprites handled by <kbd>Fixes.asm</kbd>.<br><br>

				To have this be applied to carryable custom sprites, I provided a small subroutine in <kbd>Pixi/routines/SSPCheckShouldCarriedSpriteTurnInvisible.asm</kbd>, for use in PIXI's <kbd>routines</kbd>
				folder, and any carryable custom sprite used in your hack, on their graphics handler, do this (this is a template/example, most sprites uses different label names):
<div class="CodeBlock" style="width: 247px; height: 35px;"><pre>	CodeStart:
		JSR GRAPHICS</pre></div>
				turns into:
<div class="CodeBlock" style="width: 439px; height: 80px;"><pre>	CodeStart:
		%SSPCheckShouldCarriedSpriteTurnInvisible()
		BCS SkipGFX
		JSR GRAPHICS
	SkipGFX:</pre></div>
		And that will cause the sprite to skip the entire graphics routines folder when carried fully into the pipe.</li></ul>
	</li><br>
	<li>
		When the player enters the pipe, he ignores most sprites and any carried sprites with him will also ignore them too,
		combined with the above info that the player (and carried sprite) turns invisible, the fact that you actually don't need connectors besides caps, turn corners, and (maybe) dragmode block,
		to keep the player in pipe state (because it is handled by uberasm tool, most non-changing-state-blocks are <kbd>pass_if_in_pipe.asm</kbd> which becomes passible if in pipe and does nothing
		beyond that), it also means you can have SSPs setups like this:<br>
		<img src="Readme_files/DisconnectedStraightPipe.png"><br>
		Just remember that:
		<ul>
			<li>The player will keep going in whatever last sets his direction state.</li>
			<li>
				Unlike warp/drag mode, blocks in his path must not be interactable as they can interfere with the pipe traveling movement (best case is to make blocks act as <kbd>#$0025</kbd> when <kbd>!Freeram_SSP_PipeDir</kbd>'s <abbr title="bits 0~3 of a byte; the Xs in %****XXXX">low nybble</abbr> is set):
<div class="CodeBlock"><pre>incsrc "../SSPDef/Defines.asm" ;&gt;This to obtain a define that points to a RAM address use for the checking

db $42 ; or db $37
JMP MarioBelow : JMP MarioAbove : JMP MarioSide
JMP SpriteV : JMP SpriteH : JMP MarioCape : JMP MarioFireball
JMP TopCorner : JMP BodyInside : JMP HeadInside
; JMP WallFeet : JMP WallBody ; when using db $37

MarioBelow:
MarioAbove:
MarioSide:

TopCorner:
BodyInside:
HeadInside:
CheckPipeTraveling:
	LDA !Freeram_SSP_PipeDir		;&gt;Load pipe direction state
	AND.b #%00001111			;&gt;Mask out bits 4~7 so we only have bits 0~3, which are the actual pipe state.
	BEQ .NotInPipeTraveling			;&gt;If zero (not in a pipe), then Mario isn't pipe traveling
	.InPipeTraveling
		;Code here that does something while pipe traveling.
		LDY #$00			;\Example: Make this block passable
		LDA #$30			;|
		STA $1693|!addr			;/
		RTL				;&gt;And only do just nothing for a pipe-traveling player.
	.NotInPipeTraveling
		;Code here that interacts with the player while outside the pipe. Example: Insta-kill the player
		JSL $00F606|!bank
		
;WallFeet:	; when using db $37
;WallBody:

SpriteV:
SpriteH:

MarioCape:
MarioFireball:
	RTL

print "A simple test block that behaves differently depending on if the player is pipe traveling or not."

</pre></div>
			</li>
			<li>
				Same goes for custom sprites and other third-party ASM resources. Use <kbd>incsrc "&lt;path_to_SSP_defines&gt;"</kbd> (file paths must be wrapped in quotes if it has spaces) to obtain <kbd>!Freeram_SSP_PipeDir</kbd>, use it for checking its low nybble, and ignore when nonzero.
			</li>
			<li>
				If you have <kbd>!Setting_SSP_HideDuringPipeStemTravel</kbd> set to <kbd>0</kbd> in the defines, the player remains visible even when he is in the gap he's passing through. The exception of that is entering through screen scrolling doors or using warp/drag mode. Otherwise you can use
				<kbd>set_visibility_off.asm</kbd> to hide the player just before the gap and <kbd>set_visibility_on.asm</kbd> to force the player to be visible after traversing the gap.
			</li>
		</ul>
	<li>If you enter a pipe, while yoshi exist, yoshi will also turn invisible (with some 8x8 pieces still visible), I couldn't fix that.</li><br>
	<li>The routine file is also SA-1 hybrid, no need to worry about yoshi issues about it. However, you must use RAM address in banks $40/$41 should you need to use 3-byte addressing ($4XXXXX)</li><br>
	<li>
		If Mario gets on a p-balloon, Mario will keep facing the same direction prior
		grabbing it even when moving the opposite direction (so if he grabs it facing left,
		he'll keep facing left, evidence is that the screen pans in the same direction
		regardless of which left or right direction Mario is going), until the balloon wears
		off. If you try entering horizontal pipe caps that way, Mario won't enter the pipes if
		he's facing away from the cap (so he doesn't enter backwards), so if you are using this,
		you should download the
		&ldquo;<a href="https://www.smwcentral.net/?p=section&a=details&id=16550">P-balloon timer fix</a>&rdquo;
		(linked in the recommended patches), that will fix the error and always allow Mario to enter. Do note that
		being under the effect of the balloon counts as &ldquo;carrying something&rdquo;.
	</li><br>
		
	<li>
		<s>Don't make it possible for the player to to be inside these pipes while in layer
		3 tides, because since the tides still runs while freeze flag is still set ($7E:009D,
		except when taking damage, its the player animation trigger ($7E:0071)), it will push
		mario while in the pipe and causes glitches like coming out of the pipe out of nowhere
		or even &ldquo;escape&rdquo; the pipe and leaving the player's still in &ldquo;pipe physics mode&rdquo;,
		softlocking the game.</s> EDIT: This is fixed. You can now use the pipes in the tide freely.
	</li><br>
	<li>
		I had to store #$0B into $7E0071 so that when setting $7E:009D to freeze time works
		properly; most sprites don't freeze (excluding ones that doesn't check $9D (the freeze flag),
		like birds/puff of smoke on yoshi's house). Address $00CDE8 is responsible for this problem,
		this runs every frame when $7E0071 = #$00. I'll keep the store #$0B to $7E0071 in case if
		uberasm could not disable the controls properly just in case. It's also needed to prevent
		player controls during pipe movement.
	</li><br>
	<li>
		<s>For some reasons, SSP_Tiles $40D-$411, $413, $16, $417, $41C, $41E, $41F, $423, $425-$428,
		$42B-$42F, $436, $437, $43B-$43E, $440, $44B-$44F, $45E, $45F, $46F, $47E, $47F, and
		$48E uses the wrong discriptions of another block when viewed on LM, even though the
		discriptions in the asm blocks are correct, it might be a glitch with LM viewing or
		GPS's discription, I can't really fix that, so if this bothers you, simply disable it
		in the definition file, that way, it will only show up its name correctly without any
		errors. Hopefully this gets fixed, if it was, please PM me or update the file (by
		editing the files (like the if statement containing the print commands) in this package
		and removing this notice). In the future, they may be fixed due to the bugs happening in the tool itself.</s>
		EDIT: It's fixed. This is due to using a backslash character or other reserved characters.
	</li><br>


	<li id="MarioInPipeInteractWithCustomSprites">
		While most sprites don't interact with the player in any way when the player is traveling through pipes,
be aware that some sprites still do interact with the player:
	</li><br>

	<ul>

		<li>
			All smw's solid sprites (mainly platforms) that sets the player character's position when standing on them
			are hijacked to prevent misaligned entering horizontal pipes. But not some <b>custom</b> sprites (depending how
			$9D was handled if it should still interact with the player, when <kbd>!Setting_SSP_FreezeTime</kbd> not enabled by the SSP settings).
			To fix that, simply look for a code that writes (STA) to an address $94-$97 (these are the player's XY position
			in the level, $94-$95 = X position, $96-$97 = Y position), and add this to skip over setting the player's
			coordinates, and also writing $1471:

<div class="CodeBlock" style="width: 963px; height: 201px;"><pre>incsrc "../SSPDef/Defines.asm"
;^This at the top, and must be up to date (as in match) with all of them used by blocks, patch and uberasm tool.
; You may have to fiddle around with the "../" (parent directory) in case for future tools. Then make sure you
; copy and paste the folder containing the definitions where the sprite tool's exe is at.

	LDA !Freeram_SSP_PipeDir
	AND.b #%00001111		;>Check bits 0-3 to see if the player is currently in a pipe
	BNE .DontSetPos			;>If nonzero, mario is in a pipe.

	;*code that uses, lets say sprite position ($D8, $E4, $14D4, and $14E0), displaces the
	;number from it, and writes to $94-$97, and writing to $1471*

	.DontSetPos			;>Must skip ALL position-related code</pre></div>
			<li>
				Also, in case other codes that sets the player's X and Y speed or positions ($7A-$7B, $7D $13DA, $13DC
				$94-$95, and $96-$97), make sure you don't write them during pipe movement. Otherwise it will override
				and misalign Mario from the pipe. An example of this can happen is patches like wind and gravity generators
				may cause this to happen.
			</li>
		</li>
	</ul><br>
	<li>While inside the pipe:<br>

		<ul>
			<li>The player is behind the layer (<kbd>$7E13F9</kbd> is <kbd>#$02</kbd>). When his entering timer hits 0 (<kbd>!Freeram_SSP_PipeTmr</kbd>), the player (and carried sprite) turns invisible</li><br>

			<li>
				RAM address <kbd>$7E0071</kbd> is set to <kbd>#$0B</kbd> when freezing is enabled (have <kbd>!Setting_SSP_FreezeTime</kbd> set to 1)
				(due to the fact that if you set $9D to a non-zero value without setting $7E0071 to <kbd>#$0B</kbd> on an uberasm code, the freezing
				gets nullified and some stuff will ignore the freeze effect thanks to address <kbd>$00CDE8</kbd> clearing the freeze flag every frame).
			</li>
			Thus, if a sprite doesn't check those or coded in a way that interacts with the player <i>reguardless</i> of his state (including
			doing things during $9D or $71 being set), it can mess up his pipe travel and causes glitches. Things like wind generator, or wind generated
			by a sprite can push mario out of a pipe path and cause a softlock as he misses an exit or a change-direction-corner. To avoid this
			issue, a simple code mentioned earlier will solve this.
		</ul>
	</li><br>

	<li>
		When traveling downwards and hits a corner that changes the player's direction to horizontal (left or right), the blocks below the turn corner
		may be interacted. Be careful not to put instant kill, teleport, or any other such blocks there, unless you add a check to not interfere
		with the player traveling:
<div class="CodeBlock" style="height: 49px; width: 983px;"><pre>	LDA !Freeram_SSP_PipeDir		;\If inside a pipe, return.
	AND.b #%00001111			;|
	BNE InsidePipe				;/>Don't do anything as the player travel through pipes
</pre></div>
	</li><br>

	<li>
		<a name="SpeedClipping">To add to the note above, be careful with setting the travel speeds to make the player travel very fast, he may phase through
		the interaction fields of the turn corners and pipe caps (he'll pass through without triggering them). This is because SMW (and pretty much all video games, even in 3D) handles
		movement as movement broken up into &ldquo;individual step of positions&rdquo; each frame (movement isn't continuous). Each position
		of movement handles collision, but not in between these points, thus the faster the player moves, the more wider-apart these interactable positions are, and the more
		likely he'll phase and overshoot through them should the next position the player moves ends up on the other side of the interaction field:<br>
		<img src="Readme_files/CollisionPositionInteractions.png"><br>
		The player is essentially teleporting from point to point, here is what it looks like (augmented):<br>
		<img src="Readme_files/MovementFramesGif.gif"><br>
		Mario actually moves up to <u class="DottedUnderline" title="RAM address $7B and $7D contains a signed value measuring the displacement, in units of 1/16th of a pixel, so a value of #$80 is 8 pixels (#$7F may displace 8 pixels due to accumulation of fractional coordinates).">8 pixels per frame</u>, and the blocks runs a position check (if the player is centered enough within a certain range to alter his pipe
		state and snap him centered in a short distance) and &ldquo;pseudo collision points&rdquo;, therefore, the area range to trigger Mario to change direction or state
		is not a full 16x16 pixels block.
	</li><br>

	<li>
		Turn corners, and &ldquo;prep-turns&rdquo; utilize a &ldquo;pseudo collision points&rdquo; system to pick only one block at a given pixel coordinate to interact with when the player touches multiple. This is to prevent bugs when two different turn corners or other pipe parts, especially small ones, are touching each other, which
		causes the player to be able to interact with both at the same time, causing a potential softlock. The points are located here:<br>
		<img src="Readme_files/SMW_PseudoCollisionPoints.png"><br>
		It works like this:
<div class="CodeBlock" style="height: 175px; width: 889px;"><pre>
	BlockXPosition_In_Pixels = floor((XPosition + 8 + XOffset) / 16) * 16
	BlockYPosition_In_Pixels = floor((YPosition + ToPlayerBottomTile + YOffset) / 16) * 16
	
	- "In_Pixels" refer to the XY position in pixels, meaning each block along an axis is 16 units, rather than 1 unit.
	- Floor(x / 16) * 16 <a href="https://en.wikipedia.org/wiki/Rounding#Rounding_to_a_specified_multiple">rounds</a> the number downwards to the nearest 16.
	  The bitwise equivalent is AND.w #%1111111111110000, clearing bits 0~3.
	- XPosition and YPosition are the player's coordinate, RAM $94~$95 and $96~$97.
	- XOffset and YOffset is a custom offset from the center of the player's bottom 16x16 tile (signed)
	- ToPlayerBottomTile is either:
	-- #$0018 if not riding yoshi
	-- #$0028 if riding yoshi</pre></div>
		GPS subroutine <kbd>CheckIfPlayerBottom16x16CenterIsInBlock</kbd> handle this to determine if the point is within the currently processed block. Now note: When the player is horizontally centered in-between 2 adjacent blocks,
		using the exact horizontal center (<kbd>XOffset = 8</kbd>) point of the player would end up picking the block to the right rather than the left. In this case, left block's code would call the subroutine with <kbd>XOffset = 6</kbd> instead.
	</li>

	<li>
		If you're not using custom sprites, RAM address <kbd>$7FAB10</kbd> (<kbd>$400040</kbd> SA-1) aren't initialized, thus
		can cause issues like yoshi keeping his facing direction from when you enter after exiting a
		horizontal pipe. This can be fixed by opening <kbd>SSPDef/Defines.asm</kbd>, and setting <kbd>!Setting_SSP_UsingCustomSprites</kbd> to <kbd>0</kbd>. This is due to the fact that this ASM package assumes
		you've installed spritetool/pixi.
	</li><br>

	<li>
		<a name="SmallMarioCannotInteractAboveAndBelowHorizPipes">When traveling through horizontal small pipes, Mario will interact with the &ldquo;bottom&rdquo; offset of any blocks placed above the horizontal
		pipe. It is possible to prevent that by positing Mario lower, but he will interact with  the &ldquo;above&rdquo; offset of blocks below the pipe.
		Because of how small Mario's object collision points are <b>exactly</b> 16 pixels (full block, 15 pixels in between exclusively) tall, there is no
		Y position that interacts neither, as Mario is too tall to avoid triggering any blocks placed above and below the horizontal small pipe:
		<table>
			<tr><td><center><img src="Readme_files/SSP_SmallHorizPipeTopInter.gif"></center><br>
			If Mario is 1 pixel up (default Y position, <kbd>Player_Y_Position = Block_Y_Position - 1</kbd>) from the block he is directly inside of.</td>
	
			<td><center><img src="Readme_files/SSP_SmallHorizPipeBottomInter.gif"></center><br>
			If Mario's Y position is exactly the same Y position as the block.</td></tr>
	
			<tr><td colspan="2"><center>Small Mario's Collision  points:</center><br>
			<img src="Readme_files/MarioCollisionPoints.png"></td></tr>
			<tr><td colspan="2">Just to let you know, I've enabled debug mode (the define <kbd>!Setting_SSP_PipeDebug</kbd>) to make Mario visible when traveling through pipes.</td></tr>
		</table><br>
		However, this can be mitigated by editing small Mario's collision points location via <a href="https://www.smwcentral.net/?p=section&a=details&id=15234">interaction editor</a>,
		by moving either one of small Mario's collision points (top and bottom) closer to Mario's middle by at least 1 pixel. If you haven't edit any of the vertical centering
		caused by horizontal small pipe caps, small turn corners (and the special turn corner), you can simply just move the head interaction down by 1 pixel. I wouldn't recommend 
		moving the foot part of the collision points upwards and have the player's Y position moved downward (+1 from default Y position) else the player will be slightly be lower
		into the ground.
	</li><br><br>

	<li>
		<s>If Mario stands on a key sprite (sprite number <kbd>$80</kbd>), and enters a horizontal pipe cap the same time he picks the key up, he will carry the key as normal (albeit
		his pose is acting like he isn't carrying anything), but upon exiting the pipe, Mario may (depends on the timing of picking up the key and entering) forcibly drop the key
		(even if the player holds the dash button) due to the carrying sprites through pipe (<kbd>!Freeram_SSP_CarrySpr</kbd>) flag not being set prior entering.<br><br>
		
		It may be possible that this happens in a sequence within a frame:
		<ol>
			<li>
				The game first handles the player entering the pipe (sets his pipe status; <kbd>!Freeram_SSP_PipeDir</kbd>) with the pickup flags (RAM address
				<kbd>$7E1470</kbd> and <kbd>$7E148F</kbd>) being zero (thinks that the player isn't carrying anything)<br><br>
			</li>

			<li>
				Then later, the game handles the key being picked up, it registers that the player is picking up the key since the controller being read (checks if you are holding dash)
				is before the controller gets disabled by the code handling pipe traveling from Uberasm tool.</s> EDIT: This bug is fixed as of version 3.2.8.
			</li><br>
		</ol>
	</li>
	<li>
		If you want blocks to be passable while the player is in his pipe state (such as a pipe that goes into a solid object for scenery), I provided you this code (see below)
		Make sure all offsets must be passable during pipe travel.
<div class="CodeBlock"><pre>

incsrc "../SSPDef/Defines.asm"
;^I assume you would have this placed in the main directory of the blocks folder and not in any subfolders.
; If in subfolders, then prepend "../" to the path (example: ../../SSPDef/Defines.asm)

db $42 ; or db $37
JMP MarioBelow : JMP MarioAbove : JMP MarioSide
JMP SpriteV : JMP SpriteH : JMP MarioCape : JMP MarioFireball
JMP TopCorner : JMP BodyInside : JMP HeadInside
; JMP WallFeet : JMP WallBody ; when using db $37

MarioBelow:			;\ALL mario-related offsets MUST run a check if he is in a pipe state,
MarioAbove:			;|or bugs may occur (often Mario will get obstructed or pushed).
MarioSide:			;|
TopCorner:			;|The block can have any behavor set by Lunar Magic, however this block must
BodyInside:			;|be "ignored" during pipe travel to avoid potential issue.
HeadInside:			;/
;WallFeet:			
;WallBody:			
	PipeCheck:
		LDA !Freeram_SSP_PipeDir
		AND.b #%00001111
		BEQ .NotPipeMode
		
		.PipeMode
			LDY #$00	;\Make block passable when in pipe
			LDA #$25	;|
			STA $1693	;/
		.PipeDone
			RTL		;&gt;and don't do anything else.
		.NotPipeMode
	NotRelatedPipeCodeHere:
	
SpriteV:
SpriteH:

MarioCape:
MarioFireball:			;&gt;If you disable freezing (locking $9D), having this run the pipe check causes pipes to also be passable to fireballs when Mario is in pipe.
RTL

print "<description>"
</pre></div>
	</li><br>

	<li>
		Although, you may not use the SSPs on certain levels at your own discretion, and that you could only have the SSP uberasm tool code run at specific levels, be warned that the <kbd>Fixes.asm</kbd>
		patch will apply to all levels, meaning that the freeram addresses the SSPs use are still used even if the uberasm tool code isn't running, which can cause glitches when being set to nonzero values.
	</li><br>

	<li>
		Regular-szied screen Scrolling doors (ones that are 2-blocks tall) would have the upper tile also be a custom block due to how yoshi collision works.
	</li>
	<li>
		Due to how RAM <kbd>$78</kbd> (the RAM containing the hide player bits settings) works, bit 4 controls both hiding the player's cape tile <b>and</b> if all 8 bits are set (a value of <kbd>#$FF</kbd>),
		yoshi will be invisible. This is a problem where if I want to hide the player and its cape tile but not hide yoshi that isn't ridden, Yoshi will have to disappear. I tried hijacking <kbd>$00E2C0</kbd>
		to add a riding yoshi check (<kbd>$187A|!addr</kbd>), but the SA-1 patch also hijacks at <kbd>$00E2BD</kbd>, causing conflicts at <kbd>$00E2C0</kbd> where the two 4-byte ranges overlap:
<div class="CodeBlock" style="width: 904px; height: 153px;"><pre>
$00E2BD                                ;\SA-1's "level_mode.asm" hijacks here.
$00E2BE                                ;|
$00E2BF                                ;|
$00E2C0 ;\I tried hijacking here       ;/ &gt;An overlap of the 2 ranges here at $00E2C0, causing a crash.
$00E2C1 ;|
$00E2C2 ;|
$00E2C3 ;/
$00E2C4
$00E2C5
$00E2C6
</pre></div>
	</li>
</ul>

<hr>
<h1><a href="#TOC_CreditsBack" id="TOC_Credits">^</a>Credits</h1>
<ul>
<li>Me, <a href="https://www.smwcentral.net/?p=profile&id=18802">HammerBrother</a> (Formerly GreenHammerBro) for this ASM package.</li>
<li><a href="https://www.smwcentral.net/?p=profile&id=257">MarioE</a> and <a href="https://www.smwcentral.net/?p=profile&id=8691">Akaginite</a> for the sprite aiming routine (Akaginite fixed the code to allow unlimited distance). This is used
under uberasm tool to drag the player during warp mode.</li>
<li><a href="https://benhollis.net/"> Benjamin Hollis</a>, for letting me compress my images (via PNGGauntlet) so I can fit this package into SMWC's block section's 1MIB (1048.58KB) size limit</li>
<li><a href="https://www.smwcentral.net/?p=profile&id=41223">AmperSam</a>, for reporting an oversight with yoshi disappearing when hiding the player.</li>
<li>
	<a href="https://www.smwcentral.net/?p=profile&id=22951">MarioFanGamer</a> for finding and ripping some of the door codes (RAM <kbd>$8F</kbd> during block processing is a reliable backup of RAM <kbd>$72</kbd>, and a simple code that checks
	if the player's X position is within a certain range to allow him to enter doors) from SMW.
</li>
<li>Makers of <a href="https://www.mesen.ca/">mesen 2.0</a> (<a href="https://github.com/SourMesen/Mesen2/">github link</a>), for its powerful debugging features.</li>
</ul>
<script>
//These makes all <pre>...</pre> have an effect that double-clicking will select all the text
//in it, to make it easy to copy code and paste it in your ASM stuff.
//
//Credit:
// https://keestalkstech.com/2014/04/click-to-select-all-on-the-pre-element/
// https://www.sanwebe.com/2014/04/select-all-text-in-element-on-click
document.addEventListener('dblclick', e => {
  let pre = getClosest(e.target, "PRE");
  if (pre && e.ctrlKey) {
    let range = new Range();
    range.selectNodeContents(pre);
    document.getSelection().removeAllRanges();
    document.getSelection().addRange(range);
  }
});

function getClosest(el, tagName) {
  tagName = tagName && tagName.toUpperCase();

  if (!tagName || !el)
    return null;

  do
    if (el.nodeName === tagName)
      return el;
  while (el = el.parentNode);

  return null;
}
</script>